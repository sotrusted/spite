{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Dashboard | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrastyle %}
    {{ block.super }}
    <style>
        .dashboard-container {
            max-width: 100%;
            margin: 20px;
            color: #333;
        }
        
        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #79aec8;
        }
        
        .dashboard-header h1 {
            color: #79aec8;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .metric-card h3 {
            color: #417690;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2rem;
        }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .metric-row:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #666;
            font-weight: 500;
        }
        
        .metric-value {
            color: #333;
            font-weight: bold;
            font-size: 1.2rem;
            background: #e3f2fd;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .chart-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chart-container h3 {
            color: #417690;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .chart-canvas {
            width: 100% !important;
            height: 300px !important;
            max-height: 300px !important;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            margin-bottom: 30px;
        }
        
        .recent-items {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .recent-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
        }
        
        .recent-card h3 {
            color: #417690;
            margin-bottom: 15px;
        }
        
        .recent-item {
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .recent-item:last-child {
            border-bottom: none;
        }
        
        .recent-item-title {
            color: #333;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .recent-item-meta {
            color: #666;
            font-size: 0.9rem;
        }
        
        .refresh-btn {
            background: #417690;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: background 0.3s;
        }
        
        .refresh-btn:hover {
            background: #2b5870;
        }
        
        .last-updated {
            color: #666;
            font-size: 0.9rem;
            text-align: center;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .recent-items {
                grid-template-columns: 1fr;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>üìä Activity Dashboard</h1>
        <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh Data</button>
        <button class="refresh-btn" onclick="exportData()" style="margin-left: 10px;">üìä Export Data</button>
        <div class="last-updated" id="lastUpdated">
            Last updated: <span id="timestamp">{{ request|date:'Y-m-d H:i:s' }}</span>
        </div>
    </div>
    
    <div class="metrics-grid">
        <!-- Posts Metrics -->
        <div class="metric-card">
            <h3>üìù Posts Activity</h3>
            <div class="metric-row">
                <span class="metric-label">Last Hour</span>
                <span class="metric-value" id="posts-hour">{{ posts_metrics.hour }}</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Last 12 Hours</span>
                <span class="metric-value" id="posts-12h">{{ posts_metrics.twelve_hours }}</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Last Day</span>
                <span class="metric-value" id="posts-day">{{ posts_metrics.day }}</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Last Week</span>
                <span class="metric-value" id="posts-week">{{ posts_metrics.week }}</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Last Month</span>
                <span class="metric-value" id="posts-month">{{ posts_metrics.month }}</span>
            </div>
        </div>
        
        <!-- Comments Metrics -->
        <div class="metric-card">
            <h3>üí¨ Comments Activity</h3>
            <div class="metric-row">
                <span class="metric-label">Last Hour</span>
                <span class="metric-value" id="comments-hour">{{ comments_metrics.hour }}</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Last 12 Hours</span>
                <span class="metric-value" id="comments-12h">{{ comments_metrics.twelve_hours }}</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Last Day</span>
                <span class="metric-value" id="comments-day">{{ comments_metrics.day }}</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Last Week</span>
                <span class="metric-value" id="comments-week">{{ comments_metrics.week }}</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Last Month</span>
                <span class="metric-value" id="comments-month">{{ comments_metrics.month }}</span>
            </div>
        </div>
    </div>
    
    <!-- Charts -->
    <div class="chart-container">
        <h3>üìä Hourly Activity (Last 24 Hours)</h3>
        <canvas id="hourlyChart" class="chart-canvas"></canvas>
    </div>
    
    <div class="chart-container">
        <h3>üìà Daily Activity (Last 30 Days)</h3>
        <canvas id="dailyChart" class="chart-canvas"></canvas>
    </div>
    
    <!-- Analysis Data -->
    {% if sentiment_stats or semantic_stats %}
    <div class="metrics-grid">
        <!-- Sentiment Analysis -->
        {% if sentiment_stats %}
        <div class="metric-card">
            <h3>üé≠ Sentiment Analysis</h3>
            <div class="metric-row">
                <span class="metric-label">Total Analyzed</span>
                <span class="metric-value">{{ sentiment_stats.total_analyzed }}</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Avg Sentiment (7d)</span>
                <span class="metric-value">{{ sentiment_stats.avg_sentiment_7d|floatformat:2 }}</span>
            </div>
            {% if sentiment_stats.sentiment_trend %}
            <div style="margin-top: 15px;">
                <canvas id="sentimentTrendChart" style="height: 150px;"></canvas>
            </div>
            {% endif %}
            {% if sentiment_stats.hourly_sentiment %}
            <div class="metric-row">
                <span class="metric-label">Today's Sentiment</span>
                <span class="metric-value">
                    {% with today_avg=sentiment_stats.hourly_sentiment|first %}
                        {{ today_avg.avg_sentiment|floatformat:2 }}
                    {% endwith %}
                </span>
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        <!-- Semantic Analysis -->
        {% if semantic_stats %}
        <div class="metric-card">
            <h3>üìù Topic Analysis</h3>
            <div class="metric-row">
                <span class="metric-label">Analysis Periods</span>
                <span class="metric-value">{{ semantic_stats.total_periods }}</span>
            </div>
            {% if semantic_stats.recent_topics %}
            <div style="margin-top: 10px;">
                <strong>Recent Topics:</strong>
                {% for topic, score in semantic_stats.recent_topics.items %}
                <div style="margin: 5px 0; font-size: 0.9rem;">
                    <span style="color: #666;">{{ topic|title }}</span>: 
                    <span style="color: #333; font-weight: bold;">{{ score|floatformat:1 }}%</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
    
    <!-- Keyword Cloud -->
    {% if semantic_stats.keyword_cloud %}
    <div class="chart-container">
        <h3>üî§ Top Keywords</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
            {% for keyword, count in semantic_stats.keyword_cloud.items %}
            <span style="
                background: #e3f2fd; 
                color: #417690; 
                padding: 5px 10px; 
                border-radius: 15px; 
                font-size: {{ count|add:8 }}px;
                font-weight: bold;
                display: inline-block;
            ">{{ keyword }} ({{ count }})</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Recent Items -->
    <div class="recent-items">
        <div class="recent-card">
            <h3>Recent Posts</h3>
            {% for post in recent_posts %}
            <div class="recent-item">
                <div class="recent-item-title">{{ post.title|truncatechars:50 }}</div>
                <div class="recent-item-meta">
                    by {{ post.display_name|default:"Anonymous" }} ‚Ä¢ {{ post.date_posted|date:"M d, H:i" }}
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="recent-card">
            <h3>Recent Comments</h3>
            {% for comment in recent_comments %}
            <div class="recent-item">
                <div class="recent-item-title">{{ comment.content|truncatechars:50 }}</div>
                <div class="recent-item-meta">
                    on "{{ comment.post.title|truncatechars:30 }}" ‚Ä¢ {{ comment.created_on|date:"M d, H:i" }}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Chart.js configuration
    Chart.defaults.color = '#333';
    Chart.defaults.borderColor = '#dee2e6';
    Chart.defaults.backgroundColor = 'rgba(121, 174, 200, 0.1)';
    
    // Initialize charts
    let hourlyChart, dailyChart;
    
    function initCharts() {
        const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
        const dailyCtx = document.getElementById('dailyChart').getContext('2d');
        
        // Prepare hourly data
        const postsHourly = {{ posts_hourly|safe }};
        const commentsHourly = {{ comments_hourly|safe }};
        
        // Create 24-hour array
        const hours = Array.from({length: 24}, (_, i) => i);
        const postsHourlyData = hours.map(hour => {
            const found = postsHourly.find(p => p.hour === hour);
            return found ? found.count : 0;
        });
        const commentsHourlyData = hours.map(hour => {
            const found = commentsHourly.find(c => c.hour === hour);
            return found ? found.count : 0;
        });
        
        hourlyChart = new Chart(hourlyCtx, {
            type: 'line',
            data: {
                labels: hours.map(h => h + ':00'),
                datasets: [
                    {
                        label: 'Posts',
                        data: postsHourlyData,
                        borderColor: '#79aec8',
                        backgroundColor: 'rgba(121, 174, 200, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Comments',
                        data: commentsHourlyData,
                        borderColor: '#417690',
                        backgroundColor: 'rgba(65, 118, 144, 0.1)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#dee2e6'
                        }
                    },
                    x: {
                        grid: {
                            color: '#dee2e6'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#333'
                        }
                    }
                }
            }
        });
        
        // Prepare daily data
        const postsDaily = {{ posts_daily|safe }};
        const commentsDaily = {{ comments_daily|safe }};
        
        // Create daily labels and data
        const dailyLabels = postsDaily.map(p => p.day);
        const postsDailyData = postsDaily.map(p => p.count);
        const commentsDailyData = dailyLabels.map(day => {
            const found = commentsDaily.find(c => c.day === day);
            return found ? found.count : 0;
        });
        
        dailyChart = new Chart(dailyCtx, {
            type: 'bar',
            data: {
                labels: dailyLabels,
                datasets: [
                    {
                        label: 'Posts',
                        data: postsDailyData,
                        backgroundColor: 'rgba(121, 174, 200, 0.7)',
                        borderColor: '#79aec8',
                        borderWidth: 1
                    },
                    {
                        label: 'Comments',
                        data: commentsDailyData,
                        backgroundColor: 'rgba(65, 118, 144, 0.7)',
                        borderColor: '#417690',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#dee2e6'
                        }
                    },
                    x: {
                        grid: {
                            color: '#dee2e6'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#333'
                        }
                    }
                }
            }
        });
    }
    
    function refreshData() {
        fetch('{% url "admin:admin_dashboard_api" %}')
            .then(response => response.json())
            .then(data => {
                // Update metrics
                document.getElementById('posts-hour').textContent = data.posts_metrics.hour;
                document.getElementById('posts-12h').textContent = data.posts_metrics.twelve_hours;
                document.getElementById('posts-day').textContent = data.posts_metrics.day;
                document.getElementById('posts-week').textContent = data.posts_metrics.week;
                document.getElementById('posts-month').textContent = data.posts_metrics.month;
                
                document.getElementById('comments-hour').textContent = data.comments_metrics.hour;
                document.getElementById('comments-12h').textContent = data.comments_metrics.twelve_hours;
                document.getElementById('comments-day').textContent = data.comments_metrics.day;
                document.getElementById('comments-week').textContent = data.comments_metrics.week;
                document.getElementById('comments-month').textContent = data.comments_metrics.month;
                
                // Update timestamp
                const timestamp = new Date(data.timestamp).toLocaleString();
                document.getElementById('timestamp').textContent = timestamp;
                
                // Add visual feedback
                document.querySelectorAll('.metric-value').forEach(el => {
                    el.style.background = '#c8e6c9';
                    setTimeout(() => {
                        el.style.background = '#e3f2fd';
                    }, 1000);
                });
            })
            .catch(error => {
                console.error('Error refreshing data:', error);
                alert('Failed to refresh data');
            });
    }
    
    function exportData() {
        fetch('{% url "admin:admin_dashboard_api" %}')
            .then(response => response.json())
            .then(data => {
                const exportData = {
                    timestamp: data.timestamp,
                    posts_metrics: data.posts_metrics,
                    comments_metrics: data.comments_metrics,
                    exported_at: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dashboard-data-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Error exporting data:', error);
                alert('Failed to export data');
            });
    }
    
    // Initialize sentiment trend chart
    function initSentimentChart() {
        const sentimentCanvas = document.getElementById('sentimentTrendChart');
        if (!sentimentCanvas) return;
        
        const ctx = sentimentCanvas.getContext('2d');
        const sentimentTrend = {{ sentiment_stats.sentiment_trend|safe|default:"[]" }};
        
        if (sentimentTrend.length > 0) {
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sentimentTrend.map(item => item.date),
                    datasets: [{
                        label: 'Avg Sentiment',
                        data: sentimentTrend.map(item => item.avg_sentiment),
                        borderColor: '#417690',
                        backgroundColor: 'rgba(65, 118, 144, 0.1)',
                        tension: 0.4,
                        pointRadius: function(context) {
                            // Larger points when there's more data
                            return Math.max(2, Math.min(6, sentimentTrend[context.dataIndex].count / 2));
                        },
                        pointBackgroundColor: function(context) {
                            const sentiment = sentimentTrend[context.dataIndex].avg_sentiment;
                            if (sentiment > 0.1) return '#28a745'; // Green for positive
                            if (sentiment < -0.1) return '#dc3545'; // Red for negative
                            return '#6c757d'; // Gray for neutral
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: -1,
                            max: 1,
                            grid: { color: '#dee2e6' },
                            ticks: {
                                callback: function(value) {
                                    if (value > 0.5) return 'Very Positive';
                                    if (value > 0.1) return 'Positive';
                                    if (value > -0.1) return 'Neutral';
                                    if (value > -0.5) return 'Negative';
                                    return 'Very Negative';
                                }
                            }
                        },
                        x: { 
                            grid: { color: '#dee2e6' },
                            ticks: { maxTicksLimit: 10 }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const item = sentimentTrend[context[0].dataIndex];
                                    return `${item.day} (${item.count} items)`;
                                },
                                label: function(context) {
                                    const sentiment = context.parsed.y;
                                    let label = `Sentiment: ${sentiment.toFixed(3)}`;
                                    if (sentiment > 0.1) label += ' (Positive)';
                                    else if (sentiment < -0.1) label += ' (Negative)';
                                    else label += ' (Neutral)';
                                    return label;
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
    }

    // Initialize charts when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initCharts();
        initSentimentChart();
        
        // Auto-refresh every 5 minutes
        setInterval(refreshData, 300000);
    });
</script>
{% endblock %}
