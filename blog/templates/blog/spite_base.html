{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% block title %}
        <title>SPITE MAGAZINE</title>
    {% endblock %}
    {% block links %}
        <link href="https://fonts.googleapis.com/css2?family=Crimson+Text&family=Prata&family=Princess+Sofia&display=swap" rel="stylesheet">
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
        <link rel="shortcut icon" type="image/png" href="{% static 'favicon.ico' %}"/>
    {% endblock %}
    {% block stylesheets %}
        <link href="{% static 'css/styles.css' %}" rel="stylesheet">
    {% endblock %}
</head>
<body>

<div class="container">

    {% block spitebar %}
    <div class="spite-bar">
        <p id="spite-counter" class="spite-counter">SPITE COUNTER: {{spite}}</p>
    </div>
    {% endblock %}

    {% block notifications %}
    <div id="new-post-notification" style="display: none; position: fixed; top: 100px; background-color: green; color: white; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; animation: flash 1s infinite; z-index: 1001;">
        New post! (<span id="new-post-title"></span>)
    </div>
    {% endblock %}

    {% block header %}
    <div class="header">
        <a href="{% url 'home' %}">
            <img class="logo" src="{% static 'media/spite-logo.png' %}" alt="Spite Logo">
        </a>
	<p>In Spite of it all since {{days_since_launch}} days ago</p>
        <a class="email" href="mailto:editor@spite.fr">editor@spite.fr</a>
    </div>
    {% endblock %}


    {% block content %}
    {% endblock %}

    {% block form %}
    {% endblock %}
    
    {% block spite %}
        <div class="spite">
            <p>Every time you post, the SPITE COUNTER goes up!</p>
            <br>
	    <p id="spite-counter" class="spite-counter">{{spite}} spite -- {{active_sessions_count}} users active now -- {{daily_user_count}} users active today -- {{user_count}} alltime users</p>
        </div>
    {% endblock %}

    {% block feed %}
    {% endblock %}

    <footer class="site-footer">
        <div class="crawling-text">
            <p>Â© 2024 Spite. A So Trusted Network Solution with Deepfake FaceTime in a Teacher Girlfriend Production. All spite reserved.</p>
        </div>
    </footer>


    {% block scripts %}
    <script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }


    // Function to toggle content between detail and preview
    function toggleContent(postId) {
        var detailDiv = document.getElementById('post-detail-' + postId);
        var previewDiv = document.getElementById('post-preview-' + postId);
        var toggleButton = document.getElementById('toggle-link-' + postId); 
        if (detailDiv.style.display === 'none') {
            detailDiv.style.display = 'flex';
            previewDiv.style.display = 'none';
            toggleButton.textContent = 'Collapse';
        } else {
            detailDiv.style.display = 'none';
            previewDiv.style.display = 'flex';
            toggleButton.textContent = 'Expand';
        }
    }
    function attachCopyLinks() {
        document.querySelectorAll('a[id^="copy-link-"]').forEach(a => {
            a.addEventListener('click', function () {
                // Extract the post ID from the link's ID attribute
                const postId = this.id.replace('copy-link-', ''); // e.g., 'copy-link-123' -> '123'

                // Construct the URL dynamically
                const link = `https://spite.fr/post/${postId}`;

                // Copy the link to the clipboard
                navigator.clipboard.writeText(link).then(() => {
                    // Optional: Show a confirmation message
                    const message = document.createElement('span');
                    message.textContent = 'Link copied!';
                    message.style.color = 'green';
                    this.parentElement.appendChild(message);

                    // Remove the message after 2 seconds
                    setTimeout(() => {
                        message.remove();
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy link:', err);
                    alert('Failed to copy the link. Please try again.');
                });
            })
        })
    }
    // Attach submit event to all comment forms
    function attachEventListeners() {
        document.querySelectorAll('form[id^="comment-form-"]').forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault(); // Prevent default form submission

                const formData = new FormData(this);
                const postId = this.id.split('-').pop(); // Extract post ID from form ID
                const url = this.action; // Form action URL

                // Perform AJAX request
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken'), // Include CSRF token
                    },
                    body: formData,
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Clear the form
                            this.reset();

                            // Append the new comment to the comment list
                            const commentList = document.getElementById(`comments-list-${postId}`);
                            const newComment = document.createElement('div');
                            newComment.classList.add('comment');
                            newComment.innerHTML = `
                                <strong>${data.comment.name || 'Anonymous'}</strong>: ${data.comment.content}
                                <p><em>${data.comment.created_on}</em></p>
                            `;
                            commentList.appendChild(newComment);

                            // Make sure the comments container is visible
                            const commentsContainer = document.getElementById(`comments-container-${postId}`);
                            commentsContainer.style.display = 'block';
                        } else {
                            alert('Failed to add comment. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while adding the comment.');
                    });
                });
            });
    

        // Automatically expand comments if data-has-comments is true
        console.log("Expanding comments...");
        document.querySelectorAll('.comments-container').forEach(container => {
            const hasComments = container.dataset.hasComments === 'true';
            console.log(hasComments);

            if (hasComments) {
                container.style.display = 'block';
                console.log('Expanded');
            }
        });

        // Add click listeners for toggling comments
        document.querySelectorAll('.toggle-comments').forEach(button => {
            button.addEventListener('click', function() {
                const postId = this.dataset.postId;
                const commentsContainer = document.getElementById(`comments-container-${postId}`);
                if (commentsContainer) {
                    commentsContainer.style.display = 
                        commentsContainer.style.display === 'none' ? 'block' : 'none';
                }
            });
        });
    }; 
    function disableSubmitButton() {
        var submitButton = document.getElementById('submit-id-submit');
        console.log(submitButton.value);
        submitButton.disabled = true;
        submitButton.value = 'Posting...';  // Change the button text
    }
    function enableSubmitButton() {
        var submitButton = document.getElementById('submit-id-submit');
        submitButton.disabled = false;
        submitButton.value = 'Post';  // Change the button text
    }


    document.addEventListener('DOMContentLoaded', function() {
        // Function to get CSRF token from cookies
        attachEventListeners();
        attachCopyLinks();

    });
    
    </script>
    <script src="{% static 'js/utility_functions.js' %}" defer></script>
    <script src="{% static 'js/ajax_posts.js' %}" defer></script>
    <script src="{% static 'js/websocket_updates.js' %}" defer></script>
    {% endblock %}

    {% block page_scripts %} 

    {% endblock %}
</div>
</body>
</html>
