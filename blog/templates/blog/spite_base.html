{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% block title %}
        <title>SPITE MAGAZINE</title>
    {% endblock %}
    {% block links %}
        <link href="https://fonts.googleapis.com/css2?family=Crimson+Text&family=Prata&family=Princess+Sofia&display=swap" rel="stylesheet">
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
        <link rel="shortcut icon" type="image/png" href="{% static 'favicon.ico' %}"/>
    {% endblock %}
    {% block stylesheets %}
        <link href="{% static 'css/styles.css' %}" rel="stylesheet">
    {% endblock %}
</head>
<body>

<div class="container">

    {% block spitebar %}
    <div class="spite-bar">
        <p class="spite-counter">SPITE COUNTER: {{spite}}</p>
    </div>
    {% endblock %}

    {% block header %}
    <div class="header">
        <a href="{% url 'home' %}">
            <img class="logo" src="{% static 'media/spite-logo.png' %}" alt="Spite Logo">
        </a>
	<p>In Spite of it all since {{days_since_launch}} days ago</p>
        <a class="email" href="mailto:editor@spite.fr">editor@spite.fr</a>
    </div>
    {% endblock %}


    {% block content %}
    {% endblock %}

    {% block form %}
    {% endblock %}
    
    {% block spite %}
        <div class="spite">
            <p>Every time you post, the SPITE COUNTER goes up!</p>
            <br>
	    <p class="spite-counter">{{spite}} spite -- {{active_sessions_count}} users active now -- {{daily_user_count}} users active today -- {{user_count}} alltime users</p>
        </div>
    {% endblock %}

    {% block feed %}
    {% endblock %}

    <footer class="site-footer">
        <div class="crawling-text">
            <p>Â© 2024 Spite. A So Trusted Network Solution with Deepfake FaceTime in a Teacher Girlfriend Production. All spite reserved.</p>
        </div>
    </footer>


    {% block scripts %}
    <script>
    // Function to toggle content between detail and preview
    function toggleContent(postId) {
        var detailDiv = document.getElementById('post-detail-' + postId);
        var previewDiv = document.getElementById('post-preview-' + postId);
        var toggleButton = document.getElementById('toggle-link-' + postId); 
        if (detailDiv.style.display === 'none') {
            detailDiv.style.display = 'flex';
            previewDiv.style.display = 'none';
            toggleButton.textContent = 'Collapse';
        } else {
            detailDiv.style.display = 'none';
            previewDiv.style.display = 'flex';
            toggleButton.textContent = 'Expand';
        }
    }
    // Attach submit event to all comment forms
    function attachEventListeners() {
        document.querySelectorAll('form[id^="comment-form-"]').forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault(); // Prevent default form submission

                const formData = new FormData(this);
                const postId = this.id.split('-').pop(); // Extract post ID from form ID
                const url = this.action; // Form action URL

                // Perform AJAX request
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: formData,
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Clear the form
                            this.reset();

                            // Append the new comment to the comment list
                            const commentList = document.getElementById(`comments-list-${postId}`);
                            const newComment = document.createElement('div');
                            newComment.classList.add('comment');
                            newComment.innerHTML = `
                                <strong>${data.comment.name || 'Anonymous'}</strong>: ${data.comment.content}
                                <p><em>${data.comment.created_on}</em></p>
                            `;
                            commentList.appendChild(newComment);

                            // Make sure the comments container is visible
                            const commentsContainer = document.getElementById(`comments-container-${postId}`);
                            commentsContainer.style.display = 'block';
                        } else {
                            alert('Failed to add comment. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while adding the comment.');
                    });
                });
            });
    

        // Automatically expand comments if data-has-comments is true
        console.log("Expanding comments...");
        document.querySelectorAll('.comments-container').forEach(container => {
            const hasComments = container.dataset.hasComments === 'true';
            console.log(hasComments);

            if (hasComments) {
                container.style.display = 'block';
                console.log('Expanded');
            }
        });

        // Add click listeners for toggling comments
        document.querySelectorAll('.toggle-comments').forEach(button => {
            button.addEventListener('click', function() {
                const postId = this.dataset.postId;
                const commentsContainer = document.getElementById(`comments-container-${postId}`);
                if (commentsContainer) {
                    commentsContainer.style.display = 
                        commentsContainer.style.display === 'none' ? 'block' : 'none';
                }
            });
        });
    }; 
    function disableSubmitButton() {
        var submitButton = document.getElementById('submit-id-submit');
        console.log(submitButton.value);
        submitButton.disabled = true;
        submitButton.value = 'Posting...';  // Change the button text
    }


    document.addEventListener('DOMContentLoaded', function() {
        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        attachEventListeners();

        const postForm = document.getElementById('post-form');

        postForm.addEventListener('submit', function (e) {
            e.preventDefault(); // Prevent the default form submission
    
            const formData = new FormData(this); // Collect form data
            const url = this.action; // Get the form's action URL
    
            // Perform AJAX request
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest', // Mark it as an AJAX request
                    'X-CSRFToken': getCookie('csrftoken'), // Include CSRF token
                },
                body: formData,
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        postForm.reset(); // Clear the form
                        document.getElementById('post-success').style.display = 'block';
                        document.getElementById('post-error').style.display = 'none';
    
                        // Dynamically construct the new post HTML
                        const postList = document.getElementById('post-list');
                        const newPost = document.createElement('div');
                        newPost.classList.add('item');
                        const postId = data.post.id;
    
                        newPost.innerHTML = `
                            <div class="preview" id="post-preview-${postId}">
                                <div class="post flexbox">
                                    <div class="text-content">
                                        <h2 class="post-title">
                                            <a href="/post/${postId}/">
                                                ${data.post.title}
                                            </a>
                                        </h2>
                                        ${data.post.parent_post ? `<p>Replying to: <a href="/post/${data.post.parent_post.id}/">${data.post.parent_post.title}</a></p>` : ''}
                                        <div class="post-content">
                                            ${data.post.content ? `<p>${data.post.content}</p>` : ''}
                                        </div>
                                        <a href="javascript:void(0);" class="toggle-link" id="toggle-link-${postId}" onclick="toggleContent(${postId})">Expand</a>
                                        ${data.post.author ? `<p class="post-author">by ${data.post.author}</p>` : ''}
                                        <p class="post-date">${data.post.date_posted}</p>
                                        ${data.post.city || data.post.contact ? `
                                            <p class="post-info">
                                                ${data.post.city ? data.post.city : ''}${data.post.city && data.post.contact ? ' / ' : ''}${data.post.contact ? data.post.contact : ''}
                                            </p>` : ''}
                                    </div>
                                    ${data.post.media_file || data.post.image ? `
                                    <div class="image-content">
                                        <div class="image-container">
                                            <a href="/post/${postId}/">
                                                ${data.post.media_file && data.post.is_video ? `
                                                    <video autoplay muted loop playsinline>
                                                        <source src="${data.post.media_file}" type="video/mp4">
                                                    </video>` : ''}
                                                ${data.post.media_file && data.post.is_image ? `<img src="${data.post.media_file}" alt="${data.post.title}" loading="lazy">` : ''}
                                                ${data.post.image ? `<img src="${data.post.image}" alt="${data.post.title}" loading="lazy">` : ''}
                                            </a>
                                        </div>
                                    </div>` : ''}
                                </div>
                            </div>
                            <div class="detail" id="post-detail-${postId}" style="display: none;">
                                <div class="post flexbox">
                                    ${data.post.media_file || data.post.image ? `
                                    <div class="image-content">
                                        <div class="image-container">
                                            ${data.post.media_file && data.post.is_video ? `
                                                <video controls muted autoplay playsinline>
                                                    <source src="${data.post.media_file}" type="video/mp4">
                                                </video>` : ''}
                                            ${data.post.media_file && data.post.is_image ? `<img src="${data.post.media_file}" alt="${data.post.title}" loading="lazy">` : ''}
                                            ${data.post.image ? `<img src="${data.post.image}" alt="${data.post.title}" loading="lazy">` : ''}
                                        </div>
                                    </div>` : ''}
                                    <div class="text-content">
                                        <h1 class="post-title">${data.post.title}</h1>
                                        ${data.post.parent_post ? `<p>Replying to: <a href="/post/${data.post.parent_post.id}/">${data.post.parent_post.title}</a></p>` : ''}
                                        <div class="post-content">
                                            <p>${data.post.content}</p>
                                        </div>
                                        ${data.post.author ? `<p class="post-author">by ${data.post.author}</p>` : `<p class="post-author">by Anonymous ${data.post.anon_uuid}</p>`}
                                        <p class="post-date">${data.post.date_posted}</p>
                                    </div>
                                </div>
                            </div>
                            <div id="comment-section-${postId}">
                                <button id="toggle-comments-${postId}" class="toggle-comments" data-post-id="${postId}">
                                    Comments (0)
                                </button>
                                <div id="comments-container-${postId}" class="comments-container" style="display: none;">
                                    <div id="comments-list-${postId}">
                                        <p>No comments yet.</p>
                                    </div>
                                    <form id="comment-form-${postId}" method="post" action="/add-comment/${postId}/">
                                        <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                                        <textarea name="content" class="form-control" placeholder="Write your comment here..." required></textarea>
                                        <button type="submit">Submit</button>
                                    </form>
                                </div>
                            </div>
                        `;
                        postList.prepend(newPost); // Add the new post to the top of the list
                        attachEventListeners();

                        // Scroll slightly above the newly added post
                        const newPostPosition = newPost.getBoundingClientRect().top + window.scrollY;
                        const offset = 100; // Adjust this value for desired spacing
                        window.scrollTo({
                            top: newPostPosition - offset,
                            behavior: 'smooth'
                        });
                    } else {
                        // Display error message
                        document.getElementById('post-error').style.display = 'block';
                        document.getElementById('post-success').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('post-error').style.display = 'block';
                    document.getElementById('post-success').style.display = 'none';
                });
            });
    });
    </script>
    {% endblock %}

    {% block page_scripts %} 

    {% endblock %}
</div>
</body>
</html>
